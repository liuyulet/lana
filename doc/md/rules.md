# 1、 关于  lana 物联网平台（1.0版本）设计说明
![home.png](systems%2Fhome.png)

# 2初版规则引擎
第一版以轻量级为主，接入设备在1W台以下，且不做分布式集群部署；
以下的两种方案也是后期的版本更新的主要方向，即：代理mqtt+kafka的方案，目前是采用方案一，后续会进行第二版本的开发。

## 方案一（集成mqtt-broker）：
~~~

1：创建规则，并根据规则id进行规则存储Caffeine中，用于其他位置的快速读取。并且生成对应的规则筛选逻辑，以及设备的动作触发逻辑。
2、设备通过mqtt将设备数据上报到mqtt-broker
3、mqtt-broker将收到的数据进行规则处理。（这里引入二级队列的方案）
通过5个一级 stream 分散 Broker 发来的数据，可以避免单个队列压力过大；而后续二级队列只处理筛选后的数据，可以更好地保证业务逻辑处理的实时性。（目前不采用二级队列的方式，后期优化在考虑）
4、通过redis查找出来对应的规则信息，进行规则匹配，匹配成功后在Caffeine中查找出来对应的规则文件，进行规则执行
5、规则执行完毕之后，会有两种对应的动作，并根据对应的动作处理

（            
             设备监听整体思路：
             ①、创建规则的时候，建立对应的设备-规则关联关系，存入redis中。
             ②、队列中均是来自设备的数据，当消费者消费的时候，会判断这个设备是不是属于某个规则，一旦确定数据某个规则的时候，则触发规则
             ③、触发规则之后，匹配对应的逻辑以及规则的校验、或者是执行动作。
             ④、如果这个设备不属于某个规则，则只是将数据进行存储操作。
             

             定时任务触发整体思路：
             ①、定时规则触发，优先检索stream中书否存在对应的设备数据。如果没有则进行数据库检索。
             ②、拿到数据之后进行数据匹配，匹配到规则之后，进行规则的触发。
             ③、触发规则之后，匹配对应的逻辑以及规则的校验、或者是执行动作。
             ④、如果这个设备没有数据，则使用最近一次的设备数据进行规则处理

）
~~~
## 方案二（代理mqtt-broker）：
~~~
1、设备通过mqtt将设备数据上报到代理mqtt-broker，并通过代理mqtt-broker将数据存入到kafka消息队列中
2、通过消费kafka消息队列中的数据进行规则处理（可以考虑是否增加Flink），
3、通过redis查找出来对应的规则信息，进行规则匹配，匹配成功后在Caffeine中查找出来对应的规则文件，进行规则执行
4、规则执行完毕之后，会有两种对应的动作，并根据对应的动作处理
~~~
