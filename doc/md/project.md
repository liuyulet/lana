# 关于  lana 物联网平台（1.0版本）设计说明
![home.png](systems%2Fhome.png)
# 1、 架构说明
## 架构结构图简易示例
![framework.png](..%2Fimg%2Farchitecture%2Fframework.png)

# 2、整体要求
（1）、第一版以轻量级为主，接入设备在1W台以下，且不做分布式集群部署，但是可以支持容器化部署、多实例部署；

（2）、以mqtt、http、websocket为主协议，支持边缘计算的整体接入，但是不支持modbus、opcua、socket等直连设备，这是设备接入终端要干的活（后期会计划出专门的设备接入应用）。

（3）、想到什么在说什么吧

# 3、系统模块设计说明
## 3.1、整体页面布局方式
有的是有三级菜单，有些是没有的。不过这些可以整体的表示布局的一个整体思路

![dashboard.png](..%2Fdesign%2Fdashboard.png)
![user.png](..%2Fdesign%2Fuser.png)

## 3.2、系统模块功能设计（已完成）
维护本系统基础信息的设置。包含用户、角色、部门、系统字典、菜单管理、日志管理等。很基础的，功能也比较完善。这里不做过多的赘述了

## 3.3、接入管理功能设计（进行中）
主要包含两个功能：接入协议、客户端管理

(1)、《接入协议》已完成

该模块只解决一个事情：就是可以支持mqtt、http、websocket协议接入，以及针对于接入的客户端进行管理（第二版要考虑代理协议的处理）
![mqtt.png](..%2Fdesign%2Fmqtt.png)

(1)、《客户端管理》未开始

该功能暂未开发，预期要求如下图所示，具体字段会有误差，其功能主要包含：

连接的客户端id字段（这个不是表的主键，这个是客户端自身的clientId，一般都有固定的生成规律）， 

客户端地址字段（公网、或者私网地址），

客户端信息字段（一般是现实的设备信息，比如：设备型号、设备编号、设备描述等）

客户端连接方式字段（mqtt、http、websocket）

客户端状态字段（在线、离线）

功能区包括： 连接信息 （连接时间，断联开时间，重连次数，断联原因，以及心跳频率等），强制下线（将连接强制下线）

页面信息设计草稿：

![mqttclient.png](..%2Fdesign%2Fmqttclient.png)

## 3.4、设备模块功能设计（已完成）

主要包含三个功能：产品管理、设备管理、设备分组

(1)、《产品管理》已完成

该模块主要解决一个事情：就是可以维护（增删改查）不同产品的属性，比如：产品型号、产品属性、产品连接方式、产品的类型（是直连设备、还是边缘计算设备、还是连接边缘计算的子设备）

主体页面信息：
![priduct.png](..%2Fdesign%2Fpriduct.png)

产品详情--产品物模型：
![productMode.png](..%2Fdesign%2FproductMode.png)

产品详情--接入管理
![productji.png](..%2Fdesign%2Fproductji.png)
![productzhi.png](..%2Fdesign%2Fproductzhi.png)
![productsub.png](..%2Fdesign%2Fproductsub.png)

(2)、《设备管理》已完成

该模块主要解决一个事情：就是可以维护设备（增删改查），绑定设备与产品的关联关系。

并且支持继承产品的物模型以及单独修改定义设备本身的物模型。
通过设备的物模型，进行设置设备对应的功能（采集功能：采集数据；控制功能：开、关）

也可以通过设置的功能，进行功能的操控，比如：控制功能中的开启和关闭功能，支持远程将指令下发到设备。

更可以查看设备的实时数据监听，以及历史数据的展示功能。


主体页面信息：
![devicelist.png](..%2Fdesign%2Fdevicelist.png)
![deviceadd.png](..%2Fdesign%2Fdeviceadd.png)

设备详情--设备物模型：
![devicemode.png](..%2Fdesign%2Fdevicemode.png)

设备详情--设备功能：
![deviceset.png](..%2Fdesign%2Fdeviceset.png)

设备详情--设备服务
![deviceserve.png](..%2Fdesign%2Fdeviceserve.png)

设备详情--设备数据
![devicedata.png](..%2Fdesign%2Fdevicedata.png)

(3)、《设备分组》已完成

该模块主要解决一个事情：就是可以创建不同的分组，然后将不同的设备绑定到不同的分组中，
主要是给后期的分组操作做准备。

主体页面信息：
![group.png](..%2Fdesign%2Fgroup.png)

绑定页面信息：
![groupbinding.png](..%2Fdesign%2Fgroupbinding.png)


## 3.5、规则编排功能设计

主要包含两个功能：情景模式、情景日志

(1)、《情景模式》已完成
该模块主要解决一个事情：就是通过图形化配置，设置一套情景模式，支持定时与监听设备两种方式。

整体逻辑举例：监听空气检测设备，如果空气检测中pm2.5高于60，则打开空气净化设备，并且打开窗帘通风。如果执行完成之后，
需要将匹配到的规则与执行的结果转发到对应的信息中心中（比如执行成功之后进行消息提醒）


主体页面信息：
![rule.png](..%2Fdesign%2Frule.png)

规则编排页面信息：
![ruleset.png](..%2Fdesign%2Fruleset.png)


下面是节点分析：

①开始节点：整体的规则中支持监听设备、定时。

![rulestart.png](..%2Fdesign%2Frulestart.png)

②条件节点：支持对不同条件（根据物模型来监听，设备发送数据也是基于物模型字段拼接json进行上报）的判断。

![rulet.png](..%2Fdesign%2Frulet.png)

③设备控制节点：支持对设备功能中维护的功能进行控制（支持指定设备、指定分组），比如：开启、结束。如果多个设备控制，则还有对设备的顺序控制、以及设备超时执行是否自动通过以及自动停止等。

![devicectrolle.png](..%2Fdesign%2Fdevicectrolle.png)

④数据流转节点：支持通过接入管理中的接入协议的平台进行数据的转发。

![devicereturn.png](..%2Fdesign%2Fdevicereturn.png)


(1)、《情景日志》已完成

该模块主要解决一个事情：就是将情景模式中对设备的监听、规则的匹配、设备的控制、数据的流转情况进行展示。

该功能暂未开发，预期要求如下图所示，具体展示字段会有误差，其功能主要包含：

①情景名称字段（需要将情景模式、情景模式id进行存储）

②命中/执行时间字段（主要是用于对规则的命中或执行时间，现在是设想，后期只会取一个进行使用）

③命中条件字段（将命中的条件进行展示，如果很多，则只在详情中进行展示）

④执行时长字段（条件从命中，到执行完毕，需要记录整体的执行时间）

⑤执行结果字段（执行结果，比如：执行成功、执行失败、执行超时等）

功能区主要包括：查看详情



## 3.6、预警功能设计

(1)、《消息记录》已完成

主要包含一个功能：预警消息记录

该模块主要解决一个事情：就是将情景模式中对设备的预警处理进行展示，数据来源如下图所示：


该功能暂未开发，预期要求如下图所示，具体字段会有误差，其功能主要包含：

①预警类型字段（只要是规则中触发了预警消息，则进行存储。其中分为两种预警：一个是设备预警，一个是解除设备预警）

②预警设备字段（在触发预警消息的时候，到底是哪个设备触发了预警。然后存好进行展示）

③预警内容字段（在触发预警消息的时候，到底是哪个设备的什么属性触发了预警，又预警了什么内容模板，然后存储进行展示）

④预警规则信息字段（是哪一条规则命中了这个预警）

⑤是否已转发通过字段（一般预警之后会随机进行数据的转发，如果转发成功则记录已经转发，如果没有转发成功则记录未转发）

⑥时间字段（预警触发的时间）




## 3.7、组态功能设计（规划中）

在寻求一个合适的2D/3D大屏展示引擎。

主要包含两个功能：组态设置、组态展示（发布）

(1)、《组态设置》未开始

该模块主要解决一个事情 引入2D大屏设计器，可以进行2D大屏的设计，然后进行发布。

(2)、《组态展示》未开始

该模块主要解决一个事情 展示已经发布的2D大屏，并且可以支持全屏展示。
